{% extends "base.html" %}

{% block title %}Reporte de Valoraci√≥n de Inventario{% endblock %}

{% block content %}
<h1>üìà Reporte de Valoraci√≥n de Inventario</h1>
<!-- Banner informativo -->
<div class="alert alert-info">
    <strong>üìä Vista filtrada:</strong>
    {% if session.rol in ['administrador', 'lider_inventario'] %}
    Mostrando datos de TODAS las oficinas (acceso total)
    {% else %}
    Mostrando datos √∫nicamente de su oficina: <strong>{{ session.oficina_nombre }}</strong>
    {% endif %}
</div>

<a href="/reportes" class="btn btn-secondary">‚Üê Volver a Reportes</a>

<!-- Botones de exportaci√≥n -->
<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5>üìä Exportar Reporte</h5>
                <button class="btn btn-danger" onclick="exportarPDF()">
                    üìÑ Exportar a PDF (Stock Normal + Bajo)
                </button>
                <button class="btn btn-success" onclick="exportarExcel()">
                    üìä Exportar a Excel (Stock Normal + Bajo)
                </button>
                <button class="btn btn-info" onclick="exportarBajoStock()">
                    ‚ö†Ô∏è Exportar Solo Bajo Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estad√≠sticas generales -->
<div class="row mt-3">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h6>Valor Total Inventario</h6>
                <h4>${{ "{:,.2f}".format(valor_total|default(0)|float) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h6>Total Materiales</h6>
                <h4>{{ materiales|length }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h6>Unidades Totales</h6>
                <h4>{{ cantidad_total|default(0) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h6>Bajo Stock</h6>
                <h4>{{ materiales_bajo_stock|length }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Materiales con Bajo Stock -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">‚ö†Ô∏è Materiales con Bajo Stock (< 10 unidades) - {{ materiales_bajo_stock|length }} materiales</h5>
                <span class="badge bg-light text-dark">Valor total: ${{ "{:,.2f}".format(valor_bajo_stock|default(0)|float) }}</span>
            </div>
            <div class="card-body">
                {% if materiales_bajo_stock %}
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaBajoStock">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Material</th>
                                <th>Stock Actual</th>
                                <th>Valor Unitario</th>
                                <th>Valor Total</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mat in materiales_bajo_stock %}
                            {# ‚úÖ MANEJO SEGURO DE VALORES #}
                            {% set stock_actual = mat.cantidad|default(0) %}
                            {% set valor_unitario = mat.valor_unitario|default(0) %}
                            {% set valor_total_mat = mat.valor_total|default(0) %}

                            <tr>
                                <td>{{ mat.id|default('N/A') }}</td>
                                <td>{{ mat.nombre|default('N/A') }}</td>
                                <td><span class="badge bg-danger">{{ stock_actual }}</span></td>
                                <td>${{ "{:,.2f}".format(valor_unitario|float) }}</td>
                                <td>${{ "{:,.2f}".format(valor_total_mat|float) }}</td>
                                <td>
                                    <a href="/materiales/editar/{{ mat.id }}" class="btn btn-sm btn-warning">Reponer</a>
                                    <a href="/reportes/material/{{ mat.id }}" class="btn btn-sm btn-info">Ver Detalle</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-success">¬°Excelente! No hay materiales con bajo stock.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Stock Normal -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">‚úÖ Stock Normal (‚â• 10 unidades) - {{ materiales_stock_normal|length }} materiales</h5>
                <span class="badge bg-light text-dark">Valor total: ${{ "{:,.2f}".format(valor_stock_normal|default(0)|float) }}</span>
            </div>
            <div class="card-body">
                {% if materiales_stock_normal %}
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaStockNormal">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Material</th>
                                <th>Stock Actual</th>
                                <th>Valor Unitario</th>
                                <th>Valor Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mat in materiales_stock_normal %}
                            {# ‚úÖ MANEJO SEGURO DE VALORES #}
                            {% set stock_actual = mat.cantidad|default(0) %}
                            {% set valor_unitario = mat.valor_unitario|default(0) %}
                            {% set valor_total_mat = mat.valor_total|default(0) %}

                            <tr>
                                <td>{{ mat.id|default('N/A') }}</td>
                                <td>{{ mat.nombre|default('N/A') }}</td>
                                <td><span class="badge bg-success">{{ stock_actual }}</span></td>
                                <td>${{ "{:,.2f}".format(valor_unitario|float) }}</td>
                                <td>${{ "{:,.2f}".format(valor_total_mat|float) }}</td>
                                <td>
                                    <a href="/reportes/material/{{ mat.id }}" class="btn btn-sm btn-info">Ver Detalle</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning">No hay materiales con stock normal.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Materiales sin stock -->
{% if materiales_sin_stock %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">üì≠ Materiales Sin Stock - {{ materiales_sin_stock|length }} materiales</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tablaSinStock">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Material</th>
                                <th>Stock Actual</th>
                                <th>Valor Unitario</th>
                                <th>Valor Total</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mat in materiales_sin_stock %}
                            {# ‚úÖ MANEJO SEGURO DE VALORES #}
                            {% set stock_actual = mat.cantidad|default(0) %}
                            {% set valor_unitario = mat.valor_unitario|default(0) %}
                            {% set valor_total_mat = mat.valor_total|default(0) %}

                            <tr>
                                <td>{{ mat.id|default('N/A') }}</td>
                                <td>{{ mat.nombre|default('N/A') }}</td>
                                <td><span class="badge bg-secondary">{{ stock_actual }}</span></td>
                                <td>${{ "{:,.2f}".format(valor_unitario|float) }}</td>
                                <td>${{ "{:,.2f}".format(valor_total_mat|float) }}</td>
                                <td>
                                    <a href="/materiales/editar/{{ mat.id }}" class="btn btn-sm btn-warning">Reponer</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
    // Funci√≥n para exportar a Excel (SOLO stock normal y bajo stock)
    function exportarExcel() {
        try {
            const wb = XLSX.utils.book_new();

            // Exportar materiales con bajo stock
            if (document.getElementById('tablaBajoStock')) {
                const tablaBajoStock = document.getElementById('tablaBajoStock');
                const wsBajoStock = XLSX.utils.table_to_sheet(tablaBajoStock);
                XLSX.utils.book_append_sheet(wb, wsBajoStock, 'Bajo Stock');
            }

            // Exportar stock normal
            if (document.getElementById('tablaStockNormal')) {
                const tablaStockNormal = document.getElementById('tablaStockNormal');
                const wsStockNormal = XLSX.utils.table_to_sheet(tablaStockNormal);
                XLSX.utils.book_append_sheet(wb, wsStockNormal, 'Stock Normal');
            }

            // Verificar que hay al menos una hoja para exportar
            if (wb.SheetNames.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }

            // Guardar el archivo
            XLSX.writeFile(wb, `Reporte_Stock_${new Date().toISOString().split('T')[0]}.xlsx`);

            setTimeout(() => {
                alert('‚úÖ Exportaci√≥n a Excel completada exitosamente');
            }, 1000);
        } catch (error) {
            console.error('Error en exportaci√≥n Excel:', error);
            alert('‚ùå Error al exportar a Excel');
        }
    }

    // Funci√≥n para exportar solo bajo stock a Excel
    function exportarBajoStock() {
        try {
            if (document.getElementById('tablaBajoStock')) {
                const tablaBajoStock = document.getElementById('tablaBajoStock');
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.table_to_sheet(tablaBajoStock);
                XLSX.utils.book_append_sheet(wb, ws, 'Bajo Stock');
                XLSX.writeFile(wb, `Bajo_Stock_${new Date().toISOString().split('T')[0]}.xlsx`);

                setTimeout(() => {
                    alert('‚úÖ Exportaci√≥n de Bajo Stock completada exitosamente');
                }, 1000);
            } else {
                alert('No hay materiales con bajo stock para exportar.');
            }
        } catch (error) {
            console.error('Error en exportaci√≥n Bajo Stock:', error);
            alert('‚ùå Error al exportar Bajo Stock');
        }
    }

    // Funci√≥n para exportar a PDF
    function exportarPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // T√≠tulo del reporte
            doc.setFontSize(16);
            doc.text('Reporte de Inventario - Sistema de Gesti√≥n', 14, 15);
            doc.setFontSize(10);
            doc.text(`Generado el: ${new Date().toLocaleDateString()}`, 14, 22);

            let yPosition = 30;

            // Funci√≥n para agregar tabla
            function agregarTabla(titulo, tablaId) {
                const tabla = document.getElementById(tablaId);
                if (!tabla) return yPosition;

                // Agregar t√≠tulo de secci√≥n
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.setFontSize(12);
                doc.text(titulo, 14, yPosition);
                yPosition += 8;

                // Convertir tabla a array para PDF
                const headers = [];
                const rows = [];

                // Obtener headers
                const headerRows = tabla.querySelectorAll('thead tr');
                headerRows.forEach(headerRow => {
                    const headerCells = headerRow.querySelectorAll('th');
                    const headerRowData = [];
                    headerCells.forEach(cell => {
                        headerRowData.push(cell.textContent.trim());
                    });
                    headers.push(headerRowData);
                });

                // Obtener datos
                const dataRows = tabla.querySelectorAll('tbody tr');
                dataRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    cells.forEach(cell => {
                        // Remover botones y elementos HTML
                        const cellCopy = cell.cloneNode(true);
                        const buttons = cellCopy.querySelectorAll('button, a');
                        buttons.forEach(btn => btn.remove());
                        rowData.push(cellCopy.textContent.trim());
                    });
                    rows.push(rowData);
                });

                // Crear tabla en PDF
                doc.autoTable({
                    head: headers,
                    body: rows,
                    startY: yPosition,
                    theme: 'grid',
                    headStyles: { fillColor: [66, 139, 202] },
                    styles: { fontSize: 8 }
                });

                yPosition = doc.lastAutoTable.finalY + 10;
                return yPosition;
            }

            // Agregar solo las tablas de stock normal y bajo stock
            yPosition = agregarTabla('Materiales con Bajo Stock (< 10 unidades)', 'tablaBajoStock');
            yPosition = agregarTabla('Stock Normal (‚â• 10 unidades)', 'tablaStockNormal');

            // Guardar PDF
            doc.save(`Reporte_Stock_${new Date().toISOString().split('T')[0]}.pdf`);

            setTimeout(() => {
                alert('‚úÖ Exportaci√≥n a PDF completada exitosamente');
            }, 1000);
        } catch (error) {
            console.error('Error en exportaci√≥n PDF:', error);
            alert('‚ùå Error al exportar a PDF');
        }
    }

    // Mensaje de confirmaci√≥n para exportaciones
    document.addEventListener('DOMContentLoaded', function () {
        console.log('P√°gina de inventario cargada correctamente');
    });
</script>

<style>
    .card {
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-header {
        font-weight: bold;
    }

    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .badge {
        font-size: 0.8em;
    }

    .btn-sm {
        margin: 2px;
    }

    .btn {
        margin: 2px;
    }
</style>
{% endblock %}