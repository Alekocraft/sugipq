{% extends "base.html" %}

{% block title %}Reporte de Materiales{% endblock %}

{% block content %}
<h1>üì¶ Reporte Completo de Materiales</h1>
<!-- Banner informativo -->
<div class="alert alert-info">
    <strong>üìä Vista filtrada:</strong>
    {% if session.rol in ['administrador', 'lider_inventario'] %}
    Mostrando datos de TODAS las oficinas (acceso total)
    {% else %}
    Mostrando datos √∫nicamente de su oficina: <strong>{{ session.oficina_nombre }}</strong>
    {% endif %}
</div>
<a href="/reportes" class="btn btn-secondary">‚Üê Volver a Reportes</a>

<!-- Botones de exportaci√≥n -->
<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5>üìä Exportar Reporte</h5>
                <button class="btn btn-success" onclick="exportarExcel()">
                    üìä Exportar a Excel
                </button>
                <button class="btn btn-danger" onclick="exportarPDF()">
                    üìÑ Exportar a PDF
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5>üìä Resumen General de Materiales</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Total Materiales</h6>
                                <h4 class="text-primary">{{ materiales|length }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Valor Total Inventario</h6>
                                <h4 class="text-success">${{ "{:,.2f}".format(valor_total_inventario|default(0)|float) }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Total Solicitudes</h6>
                                <h4 class="text-warning">{{ total_solicitudes|default(0) }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Total Entregado</h6>
                                <h4 class="text-info">{{ total_entregado|default(0) }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìã Detalle por Material ({{ materiales|length }} registros)</h5>
                <small class="text-warning">üí° Desplaza horizontalmente para ver todas las columnas</small>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 600px; overflow: auto;">
                    <table class="table table-striped table-hover table-sm" id="tablaMateriales">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>ID</th>
                                <th>Material</th>
                                <th>Valor Unitario</th>
                                <th>Stock</th>
                                <th>Valor Total</th>
                                <th>Oficina</th>
                                <th>Fecha Creaci√≥n</th>
                                <th>Solicitudes</th>
                                <th>Aprobadas</th>
                                <th>Pendientes</th>
                                <th>Entregado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mat in materiales %}
                            {% set fecha_creacion = mat.fecha_creacion.strftime('%d/%m/%Y') if mat.fecha_creacion else 'N/A' %}
                            {% set stats = stats_dict.get(mat.id, [0, 0, 0, 0, 0, 0, 0]) %}

                            {# ‚úÖ MANEJO SEGURO DE VALORES NONE/UNDEFINED #}
                            {% set valor_total = mat.valor_total|default(0) %}
                            {% set total_solicitudes_mat = stats[0]|default(0) %}
                            {% set aprobadas = stats[1]|default(0) %}
                            {% set pendientes = stats[2]|default(0) %}
                            {% set entregado = stats[3]|default(0) %}
                            {% set stock_actual = mat.cantidad|default(0) %}
                            {% set valor_unitario = mat.valor_unitario|default(0) %}
                            {% set oficina_nombre = mat.oficina_id|default('N/A') %}

                            <tr>
                                <td><strong>{{ mat.id }}</strong></td>
                                <td>
                                    <strong>{{ mat.nombre }}</strong>
                                    {% if mat.usuario_creador %}
                                    <br><small class="text-muted">Creado por: {{ mat.usuario_creador }}</small>
                                    {% endif %}
                                </td>
                                <td>${{ "{:,.2f}".format(valor_unitario|float) }}</td>
                                <td>
                                    <span class="badge bg-{% if stock_actual > 10 %}success{% elif stock_actual > 0 %}warning{% else %}danger{% endif %}">
                                        {{ stock_actual }} unidades
                                    </span>
                                </td>
                                <td><strong>${{ "{:,.2f}".format(valor_total|float) }}</strong></td>
                                <td>{{ oficina_nombre }}</td>
                                <td><small>{{ fecha_creacion }}</small></td>
                                <td>
                                    <span class="badge bg-primary">{{ total_solicitudes_mat }}</span>
                                </td>
                                <td>
                                    {% if aprobadas > 0 %}
                                    <span class="badge bg-success">{{ aprobadas }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">0</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if pendientes > 0 %}
                                    <span class="badge bg-warning">{{ pendientes }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">0</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if entregado > 0 %}
                                    <span class="badge bg-info">{{ entregado }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">0</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="/reportes/material/{{ mat.id }}"
                                       class="btn btn-sm btn-info"
                                       title="Ver trazabilidad completa">
                                        üìà Trazabilidad
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if not materiales %}
                <div class="alert alert-info text-center mt-3">
                    <h5>üì≠ No hay materiales registrados</h5>
                    <p>No se encontraron materiales en el sistema.</p>
                    <a href="/materiales/crear" class="btn btn-primary">‚ûï Crear Primer Material</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table th {
        white-space: nowrap;
        position: relative;
    }

    .table td {
        vertical-align: middle;
    }

    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Incluir las librer√≠as para exportaci√≥n -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
    function exportarExcel() {
        try {
            const tabla = document.getElementById('tablaMateriales');
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(tabla);
            XLSX.utils.book_append_sheet(wb, ws, 'Materiales');
            XLSX.writeFile(wb, `Reporte_Materiales_${new Date().toISOString().split('T')[0]}.xlsx`);

            setTimeout(() => {
                alert('‚úÖ Exportaci√≥n a Excel completada exitosamente');
            }, 1000);
        } catch (error) {
            console.error('Error en exportaci√≥n Excel:', error);
            alert('‚ùå Error al exportar a Excel');
        }
    }

    function exportarPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // T√≠tulo del reporte
            doc.setFontSize(16);
            doc.text('Reporte de Materiales - Sistema de Gesti√≥n', 14, 15);
            doc.setFontSize(10);
            doc.text(`Generado el: ${new Date().toLocaleDateString()}`, 14, 22);
            doc.text(`Total de materiales: {{ materiales|length }}`, 14, 29);
            doc.text(`Valor total inventario: ${{ "{:,.2f}".format(valor_total_inventario|default(0)|float) }}`, 14, 36);

            // Crear tabla en PDF
            doc.autoTable({
                html: '#tablaMateriales',
                startY: 45,
                theme: 'grid',
                headStyles: { fillColor: [66, 139, 202] },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 15 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 20 },
                    8: { cellWidth: 20 },
                    9: { cellWidth: 20 },
                    10: { cellWidth: 20 },
                    11: { cellWidth: 25 }
                }
            });

            // Guardar PDF
            doc.save(`Reporte_Materiales_${new Date().toISOString().split('T')[0]}.pdf`);

            setTimeout(() => {
                alert('‚úÖ Exportaci√≥n a PDF completada exitosamente');
            }, 1000);
        } catch (error) {
            console.error('Error en exportaci√≥n PDF:', error);
            alert('‚ùå Error al exportar a PDF');
        }
    }
</script>
{% endblock %}